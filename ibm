#!/bin/sh

mkdir /tmp/conf.d/

echo "server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    location /ibm/console{
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass https://files_websphere_1:9043/ibm/console;
    }
    location /sample {
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://files_websphere_1:9080/sample;
    }
    
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}" > /tmp/conf.d/default.conf

echo "
version: '3.9'
services:
 db2:
  image: ibmcom/db2
  environment:
    DB2INSTANCE: db2inst1
    DB2INST1_PASSWORD: password
    LICENSE: accept
    DBNAME: nPolice
  privileged: true
  volumes:
    - ./database:/database 
  networks:
    - backend
 websphere: 
  image: ibmcom/websphere-traditional
  privileged: true
  links:
    - "db2"
  networks:
    - frontend
    - backend
 http:
  image: httpd
  privileged: true
  ports:
   - 81:80
  networks:
     - frontend
 nginx:
   image: nginx
   privileged: true
   ports:
    - 80:80
   volumes:
    - /tmp/conf.d/:/etc/nginx/conf.d/
   depends_on:
    - websphere
   networks:
     - frontend

 mq:
  image: ibmcom/mq
  privileged: true
  environment:
    LICENSE: accept
networks:
  frontend:
  backend:
volumes:
    database:
    " > /tmp/ibm
docker-compose -f /tmp/ibm up
